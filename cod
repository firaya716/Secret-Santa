import telebot
import json
import random
from telebot import types

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
API_TOKEN = '—Ç–æ–∫–µ–Ω'
bot = telebot.TeleBot(API_TOKEN)


# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
user_states = {}  # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
def load_data():
    try:
        with open('data.json', 'r') as f:
            data = json.load(f)
            if 'users' not in data:
                data['users'] = {}
            if 'games' not in data:
                data['games'] = {}
            return data
    except (FileNotFoundError, json.JSONDecodeError):
        return {"users": {}, "games": {}}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ JSON
def save_data(data):
    with open('data.json', 'w') as f:
        json.dump(data, f)

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—É! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /register –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@bot.message_handler(commands=['register'])
def register(message):
    data = load_data()
    user_id = message.from_user.id
    username = message.from_user.username
    
    if str(user_id) in data['users']:
        bot.send_message(message.chat.id, "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")
    else:
        data['users'][str(user_id)] = {"points": 0, "username": username, "game": None}
        save_data(data)
        bot.send_message(message.chat.id, "–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!")
 # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    create_game_button = types.KeyboardButton("–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É")
    join_game_button = types.KeyboardButton("–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ")
    view_players_button = types.KeyboardButton("–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–≥—Ä–æ–∫–æ–≤")
    assign_santa_button = types.KeyboardButton("–ù–∞–∑–Ω–∞—á–∏—Ç—å –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—É") 
        
    markup.add(create_game_button, join_game_button, view_players_button, assign_santa_button)
        
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
@bot.message_handler(func=lambda message: True)
def handle_buttons(message):
    data = load_data()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏
    games = data.get('games', {})  # –ü–æ–ª—É—á–∞–µ–º –∏–≥—Ä—ã –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    users = data.get('users', {})  # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    user_id = str(message.from_user.id)

    if message.text == "–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É":
        bot.send_message(message.chat.id, "–í—ã –≤—ã–±—Ä–∞–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã.")
        user_states[message.chat.id] = 'waiting_for_game_name'  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    elif message.text == "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ":
        if user_id not in users:
            bot.send_message(message.chat.id, "–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /register.")
            return
        bot.send_message(message.chat.id, "–í—ã –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã.")
        user_states[message.chat.id] = 'waiting_for_game_id'  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è ID –∏–≥—Ä—ã

    elif message.chat.id in user_states:
        if user_states[message.chat.id] == 'waiting_for_game_name':
            game_name = message.text
            game_id = str(len(games) + 1)  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∏–≥—Ä—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
            games[game_id] = {"name": game_name, "players": []}  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É –≤ —Å–ª–æ–≤–∞—Ä–µ
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            users[user_id]["game"] = game_id            
            save_data({"users": users, "games": games})  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ
            bot.send_message(message.chat.id, f"–ò–≥—Ä–∞ '{game_name}' —Å–æ–∑–¥–∞–Ω–∞ —Å ID: {game_id}.")

            del user_states[message.chat.id]  # –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

        elif user_states[message.chat.id] == 'waiting_for_game_id':
            game_id = message.text.strip()
            if game_id in games:
                game_name = games[game_id]["name"]
                games[game_id]["players"].append(users[user_id]["username"])  # –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –∏–≥—Ä—É
                users[user_id]["game"] = game_id  # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ                
                save_data({"users": users, "games": games})  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ
                bot.send_message(message.chat.id, f"–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ '{game_name}'.")
                del user_states[message.chat.id]  # –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            else:
                bot.send_message(message.chat.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID –∏–≥—Ä—ã.")
                del user_states[message.chat.id]  # –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

    elif message.text == "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–≥—Ä–æ–∫–æ–≤":
        user_game_id = users.get(user_id, {}).get("game")  # –ü–æ–ª—É—á–∞–µ–º ID –∏–≥—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_game_id is None:
            bot.send_message(message.chat.id, "–í—ã –Ω–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –Ω–∏ –∫ –æ–¥–Ω–æ–π –∏–≥—Ä–µ.")
        else:
            players_in_game = [user["username"] for user in users.values() if user.get("game") == user_game_id]
            if players_in_game:
                players_list = "\n".join(players_in_game)
                bot.send_message(message.chat.id, f"–ò–≥—Ä–æ–∫–∏ –≤ –≤–∞—à–µ–π –∏–≥—Ä–µ:\n{players_list}")
            else:
                bot.send_message(message.chat.id, "–í –≤–∞—à–µ–π –∏–≥—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")
            
    elif message.text == "–ù–∞–∑–Ω–∞—á–∏—Ç—å –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—É":
        user_id = message.from_user.id
        user_game_id = users.get(str(user_id), {}).get("game")  # –ü–æ–ª—É—á–∞–µ–º ID –∏–≥—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        if user_game_id is None:
            bot.send_message(message.chat.id, "–í—ã –Ω–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –Ω–∏ –∫ –æ–¥–Ω–æ–π –∏–≥—Ä–µ.")
        else:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã
            players_in_game = [user_id for user_id in users if users[user_id]["game"] == user_game_id]
            if len(players_in_game) < 2:
                bot.send_message(message.chat.id, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—ã.")
                return
            
            # –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç–∞
            random.shuffle(players_in_game)
            assignments = {players_in_game[i]: players_in_game[(i + 1) % len(players_in_game)] for i in range(len(players_in_game))}
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            for player in players_in_game:
                users[player]["santa"] = assignments[player]
                
            save_data({"users": users, "games": games})  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É –µ–≥–æ –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—É
            for player in players_in_game:
                santa_username = users[assignments[player]]["username"]
                bot.send_message(player, f"–í—ã –¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞ –¥–ª—è: {santa_username}")

            bot.send_message(message.chat.id, "üéÖ –î–æ—Ä–æ–≥–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –≤–∞—Å —Å —É—Å–ø–µ—à–Ω—ã–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—ã! üéÅ–ü—É—Å—Ç—å —ç—Ç–æ –≤—Ä–µ–º—è –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω–æ —Ä–∞–¥–æ—Å—Ç—å—é, —Å—é—Ä–ø—Ä–∏–∑–∞–º–∏ –∏ —Ö–æ—Ä–æ—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º. –ñ–µ–ª–∞–µ–º –≤–∞–º —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –∏ –≤–µ—Å–µ–ª–æ–π –∏–≥—Ä—ã!")     

 
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    bot.polling(none_stop=True)
